1. **Мотивация:** 
    Мониторинг системы "Александрит" необходим для повышения надёжности, устойчивости и быстрого реагирования на возможные проблемы в системе. Компания сталкивается с ростом числа заказов, увеличением нагрузки и задержками в обработке, что уже привело к жалобам клиентов и потере контрактов. Внедрение мониторинга поможет команде администраторов и разработчиков быстро получать информацию о состоянии системы и делать точные выводы о причинах сбоев, обеспечивая своевременное принятие решений, например:
   - 1.1. **Своевременно выявлять проблемы с производительностью**, такими как медленные расчёты, задержки в передаче сообщений между CRM и MES, перегрузки на API.
   - 1.2. **Оперативно реагировать на инциденты**, улучшая обслуживание как внешних клиентов (API), так и внутренних пользователей (операторов, продавцов).
   - 1.3. **Анализировать и оптимизировать работу системы**, предотвращая узкие места, улучшая взаимодействие с системой и снижая риски потерь заказов.
   - 1.4. **Поддерживать устойчивую работу системы** при линейном росте заказов, что особенно важно для будущего масштабирования.

2. **Выбор подхода к мониторингу:**
   - 2.1. **Для API и сервисов: RED (Rate, Errors, Duration).**  
   Это позволит эффективно отслеживать общую производительность API и выявлять узкие места.
     - a. **Rate:** скорость обработки запросов API.
     - b. **Errors:** процент ошибок при вызове API (внешние и внутренние ошибки).
     - c. **Duration:** время обработки запросов.
   - 2.2. **Для базы данных и работы с очередями: USE (Utilization, Saturation, Errors).**  
   Такой подход поможет предотвратить перегрузки и задержки в очередях и БД.
     - a. **Utilization:** загрузка ресурсов (ЦП, память, использование диска).
     - b. **Saturation:** уровни насыщенности очередей и базы данных.
     - c. **Errors:** количество ошибок при работе с БД или очередями (RabbitMQ).
   - 2.3. **Для всей системы в целом: "Четыре золотых сигнала" (Latency, Traffic, Errors, Saturation)**
     - a. **Latency:** время отклика системы (время расчёта стоимости заказов, время выполнения запросов).
     - b. **Traffic:** объём данных, передаваемых в системе (загрузка сети).
     - c. **Errors:** процент ошибок в разных частях системы (бэкенд, брокер сообщений, API).
     - d. **Saturation:** насыщенность и использование ресурсов (очереди, база данных, использование процессора).
     
3. **Метрики для мониторинга системы:**
   - 3.1. **API (RED подход):**

   | Название                     | Зачем                                                                 | Ярлыки                                         |
      |------------------------------|----------------------------------------------------------------------|-----------------------------------------------|
   | Rate (Скорость запросов)     | позволяет оценить нагрузку на API и определить, когда требуется масштабирование. | тип запроса (GET, POST), статус ответа (2xx, 4xx, 5xx) |
   | Errors (Ошибки API)          | мониторинг ошибок помогает выявить проблемы с обработкой запросов (например, ошибки 500 или 404). | код ошибки (500, 404, 503), тип запроса       |
   | Duration (Время обработки запросов) | помогает оценить производительность API, особенно при высоких нагрузках.        | тип запроса, тип клиента (внешний API-пользователь или внутренний оператор) |

   - 3.2. **Очереди сообщений (USE подход):**

   | Название                          | Зачем                                                                 | Ярлыки                |
      |-----------------------------------|----------------------------------------------------------------------|-----------------------|
   | Utilization (Загрузка очередей RabbitMQ) | позволяет отслеживать загруженность очередей и предотвратить их переполнение. | имя очереди          |
   | Saturation (Насыщенность очередей)| показывает, насколько близко очередь к перегрузке, что важно для предотвращения потерь данных. | имя очереди          |
   | Errors (Ошибки обработки сообщений) | позволяет отслеживать проблемы с передачей сообщений между CRM и MES. | имя очереди, тип сообщения |

   - 3.3. **База данных (USE подход):**

   | Название                                   | Зачем                                                                                     | Ярлыки                                  |
      |-------------------------------------------|------------------------------------------------------------------------------------------|-----------------------------------------|
   | Utilization (Загрузка CPU и диска для PostgreSQL) | отслеживание загрузки ресурсов базы данных позволяет оценить необходимость масштабирования. | тип операции (INSERT, SELECT), имя таблицы |
   | Saturation (Количество активных соединений)| помогает выявить проблемы с насыщенностью базы, когда число подключений близко к лимиту.   | имя базы данных                         |
   | Errors (Ошибки при операциях с БД)        | отслеживание ошибок в базе данных (например, блокировки, ошибки транзакций) помогает предотвратить критические сбои. | тип операции, имя таблицы              |

   - 3.4. **Обще системные метрики ("Четыре золотых сигнала"):**

   | Название                        | Зачем                                                                                     | Ярлыки                |
      |---------------------------------|------------------------------------------------------------------------------------------|-----------------------|
   | Latency (Задержки в системе)    | важно для отслеживания времени отклика основных операций (например, расчёта стоимости заказа). | сервис, операция     |
   | Traffic (Трафик сети и объёмы передаваемых данных) | позволяет оценить использование сетевых ресурсов, что важно при росте числа заказов и клиентов. | сервис, тип трафика  |
   | Errors (Процент системных ошибок) | помогает отслеживать общее количество ошибок по всем сервисам.                            | сервис, тип ошибки   |
   | Saturation (Загрузка ресурсов системы) | отслеживание насыщенности ресурсов (ЦП, память) позволяет предотвратить деградацию производительности. | узел сервера, сервис |


4. **План действий:**
   - 4.1. **Развернуть систему мониторинга:**
     - a. Создать инстанс time-series базы данных для хранения метрик (например, Prometheus).
     - b. Настроить дашборды в Grafana для визуализации метрик.
   - 4.2. **Настроить сбор метрик с API и баз данных:**
     - a. Внедрить метрики для API и RabbitMQ (использование инструментов, таких как Prometheus Exporter).
     - b. Настроить метрики производительности для PostgreSQL с помощью `pg_stat_statements`.
   - 4.3. **Настроить алерты и нотификации:**
     - a. Создать алерты в Grafana для критических метрик (ошибки, перегрузка ресурсов, превышение задержек).
     - b. Настроить отправку уведомлений через Telegram, e-mail или другие инструменты.
   - 4.4. **Автоматизировать масштабирование при превышении порогов:**
     - a. Настроить систему автоматического масштабирования API и очередей при превышении порогов насыщенности.

5. **Показатели насыщенности:**
   - 5.1. **Загрузка API (Rate):**
      - a. **Порог:** более 1000 rps.
      - b. **Действие:** автоматическое увеличение инстансов API.
   - 5.2. **Задержка API (Duration):**
      - a. **Порог:** задержка более 1 сек для обработки запроса.
      - b. **Действие:** отправка алерта и тикета разработчикам.
   - 5.3. **Насыщенность очередей RabbitMQ:**
      - a. **Порог:** более 80% заполнения очереди.
      - b. **Действие:** добавить новые очереди или увеличить лимиты существующих.
   - 5.4. **Нагрузка на базу данных (CPU Utilization):**
      - a. **Порог:** использование ЦП более 85% в течение 5 минут.
      - b. **Действие:** добавить инстансы базы данных.